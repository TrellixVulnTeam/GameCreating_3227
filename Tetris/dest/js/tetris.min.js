class Background{static BGM_NUM=4;static INTERVAL_OF_BGM=11400;static loadBGMS(e){Background.BGMS=new Array(Background.BGM_NUM);for(let t=0;t<Background.BGM_NUM;t++)Background.BGMS[t]=e.loadSound(`assets/sound/bgm${t}.mp3`);Background.BLOCK_DESTROY=e.loadSound("assets/sound/block_destroy.mp3"),Background.GAMEOVER=e.loadSound("assets/sound/game_over.mp3")}static set(){Background.indexOfBGM=3,Background.playingCount=1e9,Mylib.shuffle(Background.BGMS)}static pause(){Background.BGMS[Background.indexOfBGM].pause(),Background.playingCount=0}static loopBGM(t){Background.playingCount>Background.INTERVAL_OF_BGM&&t.keyIsPressed?(Background.indexOfBGM=(Background.indexOfBGM+1)%Background.BGM_NUM,Background.playingCount=0,Background.BGMS[Background.indexOfBGM].play()):Background.playingCount++}}class Block{static L=20;constructor(t,e,s,i=0,o=!1){this.p=t,this.x=e,this.y=s,this.design=i,this.lit=o,this.isLocked=!1,Object.seal(this)}getLit(){return this.lit}setLit(t){this.lit=t}getIsLocked(){return this.isLocked}setIsLocked(t){this.isLocked=t}getDesign(){return this.design}setDesign(t){this.design=t}clone(t){this.design=t.design,this.lit=t.lit,this.isLocked=t.isLocked}editMode(){this.p.isKeyPressed&&"z"===this.p.key&&(this.x=this.p.mouseX,this.y=this.p.mouseY,console.log(`${this.x}, ${this.y}`))}draw(){this.lit&&this.p.image(Pattern.DESINGS[this.design],this.x,this.y,Block.L,Block.L)}}class Game{static W=15;static H=32;static START_X=6;static START_Y=1;static DEFAULT_FALL_SPEED=30;constructor(i,t,e){this.p=i,this.x=t,this.y=e,this.field=new Array(Game.H),this.fallSpeed=Game.DEFAULT_FALL_SPEED,this.top=Game.H-1,this.score=0,this.combo=0,this.scoreX=t-312,this.scoreY=e-2,this.timerX=t+456,this.timerY=e+100,this.timeLimit=180,this.variablesForGameOver={isGameOver:!1,red:0},this.p.textSize(35),this.p.textAlign(this.p.RIGHT),this.p.fill(255);for(let s=0;s<Game.H;s++){this.field[s]=new Array;for(let e=0;e<Game.W;e++){let t=new Block(i,this.x+e*Block.L+2*e,this.y+s*Block.L+2*s,Pattern.NUM);s!=Game.H-1&&0!=e&&e!=Game.W-1||(t.setLit(!0),t.setIsLocked(!0)),this.field[s].push(t)}}this.activeMino=Mino.createMino(i,Game.START_X,Game.START_Y,!0,this),addEventListener("keydown",t=>{t.preventDefault()})}getBlock(t,e){return this.field[t][e]}shift(t,s){if(0<t-s){var i=this.field[t-s];let e=this.field[t];for(let t=1;t<Game.W-1;t++)e[t].clone(i[t])}else{let e=this.field[t];for(let t=1;t<Game.W-1;t++)e[t].setLit(!1),e[t].setIsLocked(!1)}}breakOut(){let t;for(t=Game.H-2;t>=this.top;t--)if(this.field[t].every(t=>t.getLit())){t;break}var e=t;for(t=e;t>=this.top&&!this.field[t].some(t=>!t.getLit());t--);var s=e-t;if(0==s)return this.combo=0,void this.updateCombo();for(let t=e;t>=this.top;t--)this.shift(t,s);this.top+=s,this.combo++,this.score+=this.combo*(Game.W-2)*s*100,this.updateScore(),this.updateCombo(),Background.BLOCK_DESTROY.play()}updateScore(){}updateCombo(){}updateTimer(){this.p.frameCount%60==0&&this.timeLimit--}showScoreBoad(){this.p.image(Pattern.scoreBoad,this.scoreX,this.scoreY),this.p.text(this.score,this.scoreX+300,this.scoreY+50),this.p.text(this.combo,this.scoreX+300,this.scoreY+118)}showTimer(){this.p.push(),this.p.textSize(60),this.p.fill(this.p.color(61,61,243)),this.p.text(this.timeLimit,this.timerX,this.timerY),this.p.pop()}setGameOver(){this.variablesForGameOver.isGameOver=!0,Background.pause(),Background.GAMEOVER.play()}gameOver(){this.p.push(),this.p.textSize(50),this.p.textAlign(this.p.LEFT),this.p.fill(this.variablesForGameOver.red,0,0),this.variablesForGameOver.red++,this.p.text("Game Over",this.x+26,this.y+350),this.p.pop();for(let t=0;t<Game.H;t++)this.field[t][0].draw();for(let t=0;t<Game.H;t++)this.field[t][Game.W-1].draw();for(let t=1;t<Game.W-1;t++)this.field[Game.H-1][t].draw()}draw(){if(this.showScoreBoad(),this.showTimer(),this.variablesForGameOver.isGameOver)this.gameOver();else{for(let e=0;e<Game.H;e++)for(let t=0;t<Game.W;t++)this.field[e][t].draw();this.updateTimer(),!(this.timeLimit<=0)&&(this.activeMino.isActive||(this.activeMino=Mino.createMino(this.p,Game.START_X,Game.START_Y,!0,this),null!==this.activeMino))?this.activeMino.draw(this):this.setGameOver()}}}class Mino{static NUM=4;constructor(t,e,s,i,o){this.p=t,this.x=e,this.y=s,this.pattern=i,this.blocks=new Array(Mino.NUM);for(let t=0;t<Mino.NUM;t++)this.blocks[t]=[e+Pattern.SHAPES[i][t][0],s+Pattern.SHAPES[i][t][1]];this.isActive=o}static createMino(t,e,s,i,o){var r=Math.floor(Math.random()*Pattern.NUM);let a=new Mino(t,e,s,r,i);return a.blocks.some(t=>o.getBlock(t[1],t[0]).getIsLocked())&&(a=null),a}judgeLeft(e){return this.blocks.some(t=>e[t[1]][t[0]-1].getIsLocked())}judgeRight(e){return this.blocks.some(t=>e[t[1]][t[0]+1].getIsLocked())}judgeBottom(e){return this.blocks.some(t=>e[t[1]+1][t[0]].getIsLocked())}moveLeft(s){if(!this.judgeLeft(s)){--this.x;for(let e=0;e<Mino.NUM;e++){let t=this.blocks[e];s[t[1]][t[0]].setLit(!1),--t[0]}}}moveRight(s){if(!this.judgeRight(s)){this.x+=1;for(let e=0;e<Mino.NUM;e++){let t=this.blocks[e];s[t[1]][t[0]].setLit(!1),t[0]+=1}}}moveDown(s){if(!this.judgeBottom(s)){this.y+=1;for(let e=0;e<Mino.NUM;e++){let t=this.blocks[e];s[t[1]][t[0]].setLit(!1),t[1]+=1}}}static myCopy(e){let s=new Array(Mino.NUM);for(let t=0;t<Mino.NUM;t++)s[t]=[e[t][0],e[t][1]];return s}rotateLeft(o){var e=Mino.myCopy(this.blocks);try{let i=0;for(let t=0;t<Mino.NUM;t++){let s=this.blocks[t];o[s[1]][s[0]].setLit(!1);var r=s[0]-this.x,a=s[1]-this.y;if([r,a]=[-a,r],[s[0],s[1]]=[this.x+r,this.y+a],s[1]>=Game.h||o[s[1]][s[0]]){let t=0,e=s[1];for(;e>=Game.h||o[e][s[0]].getIsLocked();)e--,t++;i=this.p.max(i,t)}}for(let t=0;t<Mino.NUM;t++)this.y-=i,this.blocks[t][1]-=i}catch(t){t instanceof TypeError?this.blocks=e:console.error(t)}}rotateRight(o){var e=Mino.myCopy(this.blocks);try{let i=0;for(let t=0;t<Mino.NUM;t++){let s=this.blocks[t];o[s[1]][s[0]].setLit(!1);var r=s[0]-this.x,a=s[1]-this.y;if([r,a]=[a,-r],[s[0],s[1]]=[this.x+r,this.y+a],s[1]>=Game.h||o[s[1]][s[0]]){let t=0,e=s[1];for(;e>=Game.h||o[e][s[0]].getIsLocked();)e--,t++;i=this.p.max(i,t)}}for(let t=0;t<Mino.NUM;t++)this.y-=i,this.blocks[t][1]-=i}catch(t){t instanceof TypeError?this.blocks=e:console.error(t)}}lock(t){let e=t.field,s=1e9;for(let t=0;t<Mino.NUM;t++){var i=this.blocks[t];e[i[1]][i[0]].setLit(!0),e[i[1]][i[0]].setIsLocked(!0),s=this.p.min(s,i[1])}this.isActive=!1,t.top=this.p.min(t.top,s)}draw(t){var s=t.field;if(this.isActive){if(this.judgeBottom(s)&&this.p.frameCount%30==0)return this.lock(t),void t.breakOut();if(this.p.keyIsPressed&&this.p.frameCount%6==0)switch(this.p.keyCode){case 37:this.moveLeft(s);break;case 40:this.moveDown(s),this.moveDown(s),this.moveDown(s);break;case 39:this.moveRight(s);break;case 65:this.rotateLeft(s);break;case 68:this.rotateRight(s)}this.p.frameCount%t.fallSpeed==0&&this.moveDown(s);for(let e=0;e<Mino.NUM;e++){var i=this.blocks[e];let t=s[i[1]][i[0]];t.setDesign(this.pattern),t.setLit(!0)}}}}class Mylib{static showMemory(t,e){t.frameCount%e==0&&(e=performance.memory,console.log(e),e=e.usedJSHeapSize/e.jsHeapSizeLimit,console.log(`メモリ使用率: ${100*e} %`),console.log(`----稼働時間: ${frameCount/60}秒----`))}static shuffle(e){for(let t=e.length-1;0<=t;t--){var s=Math.floor(Math.random()*t);[e[t],e[s]]=[e[s],e[t]]}}static rand(t,e){return t+Math.floor(Math.random()*e)}static plusMinus(){return(-1)**(Math.random()<.5)}static removeExtname(e){let s="";for(let t=0;t<e.length&&"."!==e[t];t++)s+=e[t];return s}}class Pattern{static NUM=7;static SHAPES=[[[-1,0],[0,-1],[0,0],[1,0]],[[0,0],[0,1],[1,1],[2,1]],[[0,0],[1,0],[2,0],[2,-1]],[[0,0],[1,0],[1,1],[0,1]],[[0,-1],[0,0],[0,1],[0,2]],[[-1,0],[0,0],[0,1],[1,1]],[[-1,0],[0,0],[0,-1],[1,-1]]];static DESINGS=new Array(Pattern.NUM+1);static setDesign(e){for(let t=0;t<Pattern.NUM+1;t++)Pattern.DESINGS[t]=e.loadImage(`assets/img/tetris/pattern${t}.png`);Pattern.scoreBoad=e.loadImage("assets/img/tetris/score_boad.png")}}const Manager=require("./manager.min.js");exports.Game=Game,exports.Mino=Mino,exports.Block=Block,exports.Pattern=Pattern,exports.Background=Background,exports.Mylib=Mylib;