"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var _react=_interopRequireDefault(require("react")),_reactDom=_interopRequireDefault(require("react-dom")),_managerMin=_interopRequireDefault(require("./manager.min.js"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _createSuper(a){var n=_isNativeReflectConstruct();return function(){var e,t=_getPrototypeOf(a);return _possibleConstructorReturn(this,n?(e=_getPrototypeOf(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))}}function _possibleConstructorReturn(e,t){if(t&&("object"===_typeof(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(e)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,a){return t&&_defineProperties(e.prototype,t),a&&_defineProperties(e,a),e}var Mylib=function(){function a(){_classCallCheck(this,a)}return _createClass(a,null,[{key:"charCount",value:function(e){for(var t=0,a=0;a<e.length;a++)e[a].match(/^[\u30a0-\u30ff\u3040-\u309f\u3005-\u3006\u30e0-\u9fcf]+$/)?t+=2:t+=1;return t}},{key:"split",value:function(e,t){for(var a=[],n="",r=0;r<e.length;r++)n+=e[r],e[r]===t&&(a.push(n),n="");return n&&a.push(n),a}},{key:"rand",value:function(e,t){return e+Math.floor(Math.random()*t)}},{key:"generateID",value:function(e){for(var t=a.rand(0,Number.MAX_SAFE_INTEGER);e[t];);return e[t]=!0,t}}]),a}(),Chat=function(){_inherits(n,_react["default"].Component);var t=_createSuper(n);function n(){var e;return _classCallCheck(this,n),(e=t.call(this)).usedCommentID={},e.state={comments:[],input:{value:[""],row:1},isActive:!1,user:!1},e.createUser=e.createUser.bind(_assertThisInitialized(e)),e.updateInput=e.updateInput.bind(_assertThisInitialized(e)),e.addComment=e.addComment.bind(_assertThisInitialized(e)),e.enterPost=e.enterPost.bind(_assertThisInitialized(e)),e.handleClickWindow=e.handleClickWindow.bind(_assertThisInitialized(e)),e.textarea=_react.default.createRef(),e.commentsBottom=_react.default.createRef(),e}return _createClass(n,[{key:"createUser",value:function(t,a,n,r){var i=this;this.state.user||(_managerMin.default.socket.emit("createUserRequest"),_managerMin.default.socket.on("createUserResponse",function(e){e={id:e.users[e.id].id,img:a,name:t,pattern:n,keyWord:r};_managerMin.default.createUser(e),i.setState({user:!0})}))}},{key:"enterPost",value:function(e){"Enter"===e.key&&(e.crtlKey||e.metaKey)&&this.addComment(e)}},{key:"refrectComment",value:function(e){var t=e.value,a=Mylib.generateID(this.usedCommentID),e=e.user,e=_react.default.createElement(User,{id:e.id,img:e.img,name:e.name,pattern:e.pattern}),a=n.generateComment(t,a,e),e=this.state.comments;e.push(a),this.setState({comments:e}),this.state.isActive&&this.commentsBottom.current.scrollIntoView()}},{key:"addComment",value:function(e){e.preventDefault();e=this.state.input.value;n.validation(e)&&(_managerMin.default.socket.emit("addCommentRequest",{value:e,user:_managerMin.default.getUser()}),this.setState({input:{value:[""],row:1}}))}},{key:"updateInput",value:function(e){var t=Mylib.split(e.target.value,"\n");t[0]||(t[0]="");var a=t.length,n=t[a-1],r=n.length,e=e.target.value.length>this.state.input.value.join("").length;30<Mylib.charCount(n)&&("\n"===(r=n[r-1])&&(r=""),t[a-1]=t[a-1].slice(0,-1)+"\n",t.push(r));3<a||e&&3===a&&"\n"===t[2].slice(-1)||("\n"===t[a-1].slice(-1)&&(e?a++:(t.pop(),a--)),this.setState({input:{value:t,row:a}}))}},{key:"activateInput",value:function(){this.setState({isActive:!(0<arguments.length&&void 0!==arguments[0])||arguments[0]})}},{key:"handleClickWindow",value:function(e){e=e.target;!this.state.user||"input-container"!==e.className&&"input"!==e.parentNode.className?this.activateInput(!1):(this.activateInput(),this.textarea.current.focus())}},{key:"componentDidMount",value:function(){var t=this;_managerMin.default.createUser()&&this.setState({user:!0}),_managerMin.default.socket.on("addCommentResponse",function(e){t.refrectComment(e)})}},{key:"render",value:function(){return _react.default.createElement("div",{id:"chat",onClick:this.handleClickWindow},_react.default.createElement(UserSelect,{user:this.state.user,createUser:this.createUser}),_react.default.createElement("div",{id:"chat-space",style:{pointerEvents:this.state.user?"all":"none"}}," ",_react.default.createElement("div",{id:"comments-container"},_react.default.createElement("ul",null,this.state.comments),_react.default.createElement("div",{ref:this.commentsBottom,id:"comments-bottom"})),_react.default.createElement(Input,{params:this.state.input,textarea:this.textarea,isActive:this.state.isActive,onChange:this.updateInput,onClick:this.addComment,onKeyDown:this.enterPost,buttonValue:"送信"}),this.state.user?null:_react.default.createElement("div",{id:"chat-mask"})," "))}}],[{key:"validation",value:function(e){e=e.join("");return 0<e.length&&e.match(/[^ 　\n\t]/)}},{key:"generateComment",value:function(e,t,a){var n="url(../assets/img/chat/cloud/cloud".concat(Mylib.rand(0,5),".png)"),r=0;e.forEach(function(e){r=Math.max(r,Mylib.charCount(e))}),r*=20,r=Math.max(r,120),i=(r=Math.min(r,380))*(100/280)*(e.length/3)*1.5;var i=Math.max(i,100),l="".concat(Mylib.rand(-60,200),"px"),n={width:"".concat(r,"px"),height:"".concat(i,"px"),marginLeft:l,backgroundSize:"".concat(r,"px ").concat(i,"px"),backgroundImage:n};return _react.default.createElement(Comment,{key:t,value:e,style:n,user:a})}}]),n}();function Comment(e){return _react.default.createElement("div",{className:"comment",style:e.style},_react.default.createElement("li",null,e.value.map(function(e,t){return _react.default.createElement("p",{key:t},e)})),e.user)}function Input(e){var t="input-container";return e.isActive&&(t+=" active"),_react.default.createElement("div",{className:t},_react.default.createElement("form",{className:"input",onKeyDown:e.onKeyDown},_react.default.createElement("textarea",{value:e.params.value.join(""),placeholder:e.placeholder,ref:e.textarea,rows:e.params.row,wrap:"hard",onChange:e.onChange}),_react.default.createElement("input",{type:"submit",value:e.buttonValue,title:"ctrl+Enter",onClick:e.onClick})))}function User(e){var t=e.pattern?{left:0}:{right:0};return _react.default.createElement("img",{src:e.img,title:e.name,style:t})}function Image(e){return _react.default.createElement("div",{className:"image-container",onClick:function(){return e.onClick(e.id)}},_react.default.createElement("img",{src:e.images[e.id]}))}function ImageSelect(a){var e=a.images.map(function(e,t){return _react.default.createElement(Image,{key:t,id:t,images:a.images,onClick:a.onClick})});return _react.default.createElement("div",{id:"image-select"},e)}function NameSelect(e){return _react.default.createElement("div",{id:"name-select"},_react.default.createElement("img",{src:e.img,alt:"user-image"}),_react.default.createElement(Input,{params:e.params,textarea:e.textarea,isActive:e.isActive,buttonValue:"決定",onChange:e.onChange,onClick:e.onClick,onKeyDown:e.onKeyDown}))}function KeyWordSelect(e){return _react.default.createElement("div",{id:"keyword-select"},_react.default.createElement("h1",null,"???"),_react.default.createElement(Input,{params:e.params,textarea:e.textarea,placeholder:e.placeholder,isActive:e.isActive,buttonValue:"決定",onChange:e.onChange,onClick:e.onClick,onKeyDown:e.onKeyDown}))}var UserSelect=function(){_inherits(a,_react["default"].Component);var t=_createSuper(a);function a(e){return _classCallCheck(this,a),(e=t.call(this,e)).state={mode:0,guide:"キャラクターをえらんでね!",img:null,pattern:null,nameInput:{value:[""],row:1},keyWordInput:{value:[""],row:1},nameIsActive:!1,keyWordIsActive:!1},e.images=Array.from(Array(15),function(e,t){return"../assets/img/chat/user/user".concat(t,".png")}),e.handleImageSelect=e.handleImageSelect.bind(_assertThisInitialized(e)),e.handleUpdateNameInput=e.handleUpdateNameInput.bind(_assertThisInitialized(e)),e.handleNameSelect=e.handleNameSelect.bind(_assertThisInitialized(e)),e.handleUpdateKeyWordInput=e.handleUpdateKeyWordInput.bind(_assertThisInitialized(e)),e.handleKeyWordSelect=e.handleKeyWordSelect.bind(_assertThisInitialized(e)),e.enterNamePost=e.enterNamePost.bind(_assertThisInitialized(e)),e.enterKeyWordPost=e.enterKeyWordPost.bind(_assertThisInitialized(e)),e.handleClickWindow=e.handleClickWindow.bind(_assertThisInitialized(e)),e.nameTextarea=_react.default.createRef(),e.keyWordTextarea=_react.default.createRef(),e}return _createClass(a,[{key:"enterNamePost",value:function(e){"Enter"===e.key&&(e.crtlKey||e.metaKey)&&this.handleNameSelect(e)}},{key:"enterKeyWordPost",value:function(e){"Enter"===e.key&&(e.crtlKey||e.metaKey)&&this.handleKeyWordSelect(e)}},{key:"handleImageSelect",value:function(e){var t=this.images[e];this.setState({img:t,pattern:7<e,mode:1,guide:"なまえをきめてね!!"})}},{key:"nameAlert",value:function(){alert("12文字以内で頼む。")}},{key:"handleUpdateNameInput",value:function(e){e=e.target.value;"\n"!==e.slice(-1)&&(12<e.length?this.nameAlert():this.setState({nameInput:{value:[e],row:1}}))}},{key:"handleNameSelect",value:function(e){e.preventDefault();e=this.state.nameInput.value;Chat.validation(e)&&this.setState({mode:2,guide:"あいことばをいれてね!!"})}},{key:"handleUpdateKeyWordInput",value:function(e){e=e.target.value;"\n"!==e.slice(-1)&&(12<e.length?this.nameAlert():this.setState({keyWordInput:{value:[e],row:1}}))}},{key:"handleKeyWordSelect",value:function(e){e.preventDefault(),this.end()}},{key:"end",value:function(){var e=this.state.keyWordInput.value[0]||"general";this.props.createUser(this.state.nameInput.value[0],this.state.img,this.state.pattern,e)}},{key:"activateNameInput",value:function(){this.setState({nameIsActive:!(0<arguments.length&&void 0!==arguments[0])||arguments[0]})}},{key:"activateKeyWordInput",value:function(){this.setState({keyWordIsActive:!(0<arguments.length&&void 0!==arguments[0])||arguments[0]})}},{key:"handleClickWindow",value:function(e){e=e.target;"input-container"===e.className||"input"===e.parentNode.className?(this.activateNameInput(),this.activateKeyWordInput(),(this.nameTextarea.current||this.keyWordTextarea.current).focus()):(this.activateNameInput(!1),this.activateKeyWordInput(!1))}},{key:"render",value:function(){if(this.props.user)return null;var e;switch(this.state.mode){case 0:e=_react.default.createElement(ImageSelect,{images:this.images,onClick:this.handleImageSelect});break;case 1:e=_react.default.createElement(NameSelect,{img:this.state.img,params:this.state.nameInput,textarea:this.nameTextarea,isActive:this.state.nameIsActive,onChange:this.handleUpdateNameInput,onClick:this.handleNameSelect,onKeyDown:this.enterNamePost});break;case 2:e=_react.default.createElement(KeyWordSelect,{params:this.state.keyWordInput,textarea:this.keyWordTextarea,placeholder:"何も入力しなくてもおｋ",isActive:this.state.keyWordIsActive,onChange:this.handleUpdateKeyWordInput,onClick:this.handleKeyWordSelect,onKeyDown:this.enterKeyWordPost})}return _react.default.createElement("div",{id:"user-select",onClick:this.handleClickWindow},_react.default.createElement("h1",null,this.state.guide),e)}}],[{key:"validation",value:function(e){e=e.join("");return 0<e.length&&e.match(/[^ 　\n\t]/)}}]),a}();_reactDom.default.render(_react.default.createElement(_react.default.StrictMode,null,_react.default.createElement(Chat,null)),document.getElementById("root"));