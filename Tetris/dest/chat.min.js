"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var _socket=require("socket.io-client"),_react=_interopRequireDefault(require("react")),_reactDom=_interopRequireDefault(require("react-dom"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var a,r,i=[],o=!0,l=!1;try{for(n=n.call(e);!(o=(a=n.next()).done)&&(i.push(a.value),!t||i.length!==t);o=!0);}catch(e){l=!0,r=e}finally{try{o||null==n.return||n.return()}finally{if(l)throw r}}return i}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _createForOfIteratorHelper(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var a=0,t=function(){};return{s:t,n:function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}},e:function(e){throw e},f:t}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,i=!0,o=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){o=!0,r=e},f:function(){try{i||null==n.return||n.return()}finally{if(o)throw r}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Map"===(n="Object"===n&&e.constructor?e.constructor.name:n)||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,a=new Array(t);n<t;n++)a[n]=e[n];return a}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _createSuper(n){var a=_isNativeReflectConstruct();return function(){var e,t=_getPrototypeOf(n);return _possibleConstructorReturn(this,a?(e=_getPrototypeOf(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))}}function _possibleConstructorReturn(e,t){if(t&&("object"===_typeof(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(e)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}var Mylib=function(){function n(){_classCallCheck(this,n)}return _createClass(n,null,[{key:"charCount",value:function(e){for(var t=0,n=0;n<e.length;n++)e[n].match(/^[\u30a0-\u30ff\u3040-\u309f\u3005-\u3006\u30e0-\u9fcf]+$/)?t+=2:t+=1;return t}},{key:"split",value:function(e,t){for(var n=[],a="",r=0;r<e.length;r++)a+=e[r],e[r]===t&&(n.push(a),a="");return a&&n.push(a),n}},{key:"rand",value:function(e,t){return e+Math.floor(Math.random()*t)}},{key:"generateID",value:function(e){for(var t=n.rand(0,Number.MAX_SAFE_INTEGER);e[t];);return e[t]=!0,t}}]),n}(),Chat=function(){_inherits(a,_react["default"].Component);var t=_createSuper(a);function a(){var e;return _classCallCheck(this,a),(e=t.call(this)).usedCommentID={},e.state={comments:[],input:{value:[""],row:1},isActive:!1,user:null},e.createUser=e.createUser.bind(_assertThisInitialized(e)),e.updateInput=e.updateInput.bind(_assertThisInitialized(e)),e.addComment=e.addComment.bind(_assertThisInitialized(e)),e.enterPost=e.enterPost.bind(_assertThisInitialized(e)),e.handleClickWindow=e.handleClickWindow.bind(_assertThisInitialized(e)),e.textarea=_react.default.createRef(),e.commentsBottom=_react.default.createRef(),e}return _createClass(a,[{key:"createUser",value:function(t,n,a){var r,i=this;this.state.user||(Manager.socket.emit("createUserRequest"),Manager.socket.on("createUserResponse",function(e){r=e.users[e.id].id,i.setState({user:{id:r,img:n,name:t,pattern:a}})}))}},{key:"enterPost",value:function(e){"Enter"===e.key&&(e.crtlKey||e.metaKey)&&this.addComment(e)}},{key:"refrectComment",value:function(e){var t=e.value,n=Mylib.generateID(this.usedCommentID),e=e.user,e=_react.default.createElement(User,{id:e.id,img:e.img,name:e.name,pattern:e.pattern}),n=a.generateComment(t,n,e),e=this.state.comments;e.push(n),this.setState({comments:e}),this.state.isActive&&this.commentsBottom.current.scrollIntoView()}},{key:"addComment",value:function(e){e.preventDefault();e=this.state.input.value;a.validation(e)&&(Manager.socket.emit("addCommentRequest",{value:e,user:this.state.user}),this.setState({input:{value:[""],row:1}}))}},{key:"updateInput",value:function(e){var t=Mylib.split(e.target.value,"\n");t[0]||(t[0]="");var n=t.length,a=t[n-1],r=a.length,e=e.target.value.length>this.state.input.value.join("").length;30<Mylib.charCount(a)&&("\n"===(r=a[r-1])&&(r=""),t[n-1]=t[n-1].slice(0,-1)+"\n",t.push(r));3<n||e&&3===n&&"\n"===t[2].slice(-1)||("\n"===t[n-1].slice(-1)&&(e?n++:(t.pop(),n--)),this.setState({input:{value:t,row:n}}))}},{key:"activateInput",value:function(){this.setState({isActive:!(0<arguments.length&&void 0!==arguments[0])||arguments[0]})}},{key:"handleClickWindow",value:function(e){console.log(document.cookie),console.log(Manager.getCookie());e=e.target;!this.state.user||"input-container"!==e.className&&"input"!==e.parentNode.className?this.activateInput(!1):(this.activateInput(),this.textarea.current.focus())}},{key:"componentDidMount",value:function(){var t=this;console.log("name: ",document.cookie.name),Manager.socket.on("addCommentResponse",function(e){t.refrectComment(e)})}},{key:"render",value:function(){return _react.default.createElement("div",{id:"chat",onClick:this.handleClickWindow},_react.default.createElement(UserSelect,{user:this.state.user,createUser:this.createUser}),_react.default.createElement("div",{id:"chat-space",style:{pointerEvents:this.state.user?"all":"none"}}," ",_react.default.createElement("div",{id:"comments-container"},_react.default.createElement("ul",null,this.state.comments),_react.default.createElement("div",{ref:this.commentsBottom,id:"comments-bottom"})),_react.default.createElement(Input,{params:this.state.input,textarea:this.textarea,isActive:this.state.isActive,handleChange:this.updateInput,handleClick:this.addComment,handleKeyDown:this.enterPost,buttonValue:"送信"}),this.state.user?null:_react.default.createElement("div",{id:"chat-mask"})," "))}}],[{key:"validation",value:function(e){e=e.join("");return 0<e.length&&e.match(/[^ 　\n\t]/)}},{key:"generateComment",value:function(e,t,n){var a="url(../assets/img/chat/cloud/cloud".concat(Mylib.rand(0,5),".png)"),r=0;e.forEach(function(e){r=Math.max(r,Mylib.charCount(e))}),r*=20,r=Math.max(r,120),i=(r=Math.min(r,380))*(100/280)*(e.length/3)*1.5;var i=Math.max(i,100),o="".concat(Mylib.rand(-60,200),"px"),a={width:"".concat(r,"px"),height:"".concat(i,"px"),marginLeft:o,backgroundSize:"".concat(r,"px ").concat(i,"px"),backgroundImage:a};return _react.default.createElement(Comment,{key:t,value:e,style:a,user:n})}}]),a}();function Comment(e){return _react.default.createElement("div",{className:"comment",style:e.style},_react.default.createElement("li",null,e.value.map(function(e,t){return _react.default.createElement("p",{key:t},e)})),e.user)}function Input(e){var t="input-container";return e.isActive&&(t+=" active"),_react.default.createElement("div",{className:t},_react.default.createElement("form",{className:"input",onKeyDown:e.handleKeyDown},_react.default.createElement("textarea",{value:e.params.value.join(""),ref:e.textarea,rows:e.params.row,wrap:"hard",onChange:e.handleChange}),_react.default.createElement("input",{type:"submit",value:e.buttonValue,title:"ctrl+Enter",onClick:e.handleClick})))}var Manager=function(){function o(){_classCallCheck(this,o)}return _createClass(o,null,[{key:"getCookie",value:function(){if(!o.cookie){var e,t={},n=_createForOfIteratorHelper(document.cookie.split(";"));try{for(n.s();!(e=n.n()).done;){var a=_slicedToArray(e.value.trim().split("="),2),r=a[0],i=a[1];t[r]=i}}catch(e){n.e(e)}finally{n.f()}o.cookie=t}return o.cookie}}]),o}();function User(e){var t=e.pattern?{left:0}:{right:0};return _react.default.createElement("img",{src:e.img,title:e.name,style:t})}function NameSelect(e){return _react.default.createElement("div",{id:"name-select"},_react.default.createElement("img",{src:e.img,alt:"user-image"}),_react.default.createElement(Input,{params:e.params,textarea:e.textarea,isActive:e.isActive,buttonValue:"決定",handleChange:e.handleChange,handleClick:e.handleClick,handleKeyDown:e.handleKeyDown}))}function Image(e){return _react.default.createElement("div",{className:"image-container",onClick:function(){return e.handleClick(e.id)}},_react.default.createElement("img",{src:e.images[e.id]}))}function ImageSelect(n){var e=n.images.map(function(e,t){return _react.default.createElement(Image,{key:t,id:t,images:n.images,handleClick:n.handleClick})});return _react.default.createElement("div",{id:"image-select"},e)}_defineProperty(Manager,"socket",(0,_socket.io)("localhost:5000"));var UserSelect=function(){_inherits(n,_react["default"].Component);var t=_createSuper(n);function n(e){return _classCallCheck(this,n),(e=t.call(this,e)).state={mode:0,guide:"キャラクターをえらんでね!",img:null,pattern:null,nameInput:{value:[""],row:1},isActive:!1},e.images=Array.from(Array(15),function(e,t){return"../assets/img/chat/user/user".concat(t,".png")}),e.handleNameSelect=e.handleNameSelect.bind(_assertThisInitialized(e)),e.handleImageSelect=e.handleImageSelect.bind(_assertThisInitialized(e)),e.handleNameChange=e.handleNameChange.bind(_assertThisInitialized(e)),e.enterPost=e.enterPost.bind(_assertThisInitialized(e)),e.handleClickWindow=e.handleClickWindow.bind(_assertThisInitialized(e)),e.textarea=_react.default.createRef(),e}return _createClass(n,[{key:"enterPost",value:function(e){"Enter"===e.key&&(e.crtlKey||e.metaKey)&&this.handleNameSelect(e)}},{key:"nameAlert",value:function(){alert("12文字以内で頼む。")}},{key:"handleNameChange",value:function(e){e=e.target.value;"\n"!==e.slice(-1)&&(12<e.length?this.nameAlert():this.setState({nameInput:{value:[e],row:1}}))}},{key:"handleImageSelect",value:function(e){var t=this.images[e];this.setState({img:t,pattern:7<e,mode:1,guide:"なまえをきめてね!!"})}},{key:"handleNameSelect",value:function(e){e.preventDefault();e=this.state.nameInput.value;Chat.validation(e)&&(this.props.createUser(e[0],this.state.img,this.state.pattern),document.cookie="name=".concat(e[0]),document.cookie="img=".concat(this.state.img),document.cookie="pattern=".concat(this.state.pattern))}},{key:"activateInput",value:function(){this.setState({isActive:!(0<arguments.length&&void 0!==arguments[0])||arguments[0]})}},{key:"handleClickWindow",value:function(e){e=e.target;"input-container"===e.className||"input"===e.parentNode.className?(this.activateInput(),this.textarea.current.focus()):this.activateInput(!1)}},{key:"render",value:function(){if(this.props.user)return null;var e;switch(this.state.mode){case 0:e=_react.default.createElement(ImageSelect,{images:this.images,handleClick:this.handleImageSelect});break;case 1:e=_react.default.createElement(NameSelect,{img:this.state.img,params:this.state.nameInput,textarea:this.textarea,isActive:this.state.isActive,handleChange:this.handleNameChange,handleClick:this.handleNameSelect,handleKeyDown:this.enterPost})}return _react.default.createElement("div",{id:"user-select",onClick:this.handleClickWindow},_react.default.createElement("h1",null,this.state.guide),e)}}],[{key:"validation",value:function(e){e=e.join("");return 0<e.length&&e.match(/[^ 　\n\t]/)}}]),n}();_reactDom.default.render(_react.default.createElement(_react.default.StrictMode,null,_react.default.createElement(Chat,null)),document.getElementById("root"));