class Background{static BGM_NUM=4;static INTERVAL_OF_BGM=11400;static loadBGMS(){Background.BGMS=new Array(Background.BGM_NUM);for(let t=0;t<Background.BGM_NUM;t++)Background.BGMS[t]=loadSound(`assets/sound/bgm${t}.mp3`);Background.BLOCK_DESTROY=loadSound("assets/sound/block_destroy.mp3"),Background.GAMEOVER=loadSound("assets/sound/game_over.mp3")}static set(){Background.indexOfBGM=3,Background.playingCount=10**9,MyFunctions.shuffle(Background.BGMS)}static pause(){Background.BGMS[Background.indexOfBGM].pause(),Background.playingCount=0}static loopBGM(){Background.playingCount>Background.INTERVAL_OF_BGM&&keyIsPressed?(Background.indexOfBGM=(Background.indexOfBGM+1)%Background.BGM_NUM,Background.playingCount=0,Background.BGMS[Background.indexOfBGM].play()):Background.playingCount++}}class Block{static L=20;constructor(t,e,i=0){this.x=t,this.y=e,this.design=Pattern.DESINGS[i],this.lit=!1,this.isLocked=!1,Object.seal(this)}getLit(){return this.lit}setLit(t){this.lit=t}getIsLocked(){return this.isLocked}setIsLocked(t){this.isLocked=t}getDesign(){return this.design}setDesign(t){this.design=t}clone(t){this.design=t.design,this.lit=t.lit,this.isLocked=t.isLocked}draw(){this.lit&&image(this.design,this.x,this.y,Block.L,Block.L)}}class Game{static W=15;static H=32;static START_X=6;static START_Y=1;static DEFAULT_FALL_SPEED=30;constructor(t,e){this.x=t,this.y=e,this.field=new Array(Game.H),this.fallSpeed=Game.DEFAULT_FALL_SPEED,this.top=Game.H-1,this.score=0,this.combo=0,this.scoreElement=$("#score"),this.comboElement=$("#combo"),this.timerElement=$("#timer"),this.timeLimit=180,this.variablesForGameOver={isGameOver:!1,red:0};for(let t=0;t<Game.H;t++){this.field[t]=new Array;for(let e=0;e<Game.W;e++){let i=new Block(this.x+e*Block.L+2*e,this.y+t*Block.L+2*t,Pattern.NUM);t!=Game.H-1&&0!=e&&e!=Game.W-1||(i.setLit(!0),i.setIsLocked(!0)),this.field[t].push(i)}}this.activeMino=Mino.createMino(Game.START_X,Game.START_Y,!0,this),Object.seal(this)}getBlock(t,e){return this.field[t][e]}shift(t,e){if(t-e>0){let i=this.field[t-e],s=this.field[t];for(let t=1;t<Game.W-1;t++)s[t].clone(i[t])}else{console.log("i - d <= 0",t,e);let i=this.field[t];for(let t=1;t<Game.W-1;t++)i[t].setLit(!1),i[t].setIsLocked(!1)}}breakOut(){let t;for(t=Game.H-2;t>=this.top&&!this.field[t].every((t=>t.getLit()));t--);let e=t;for(t=e;t>=this.top&&!this.field[t].some((t=>!t.getLit()));t--);let i=e-t;if(0==i)return this.combo=0,void this.reloadCombo();for(let t=e;t>=this.top;t--)this.shift(t,i);this.top+=i,this.combo++,this.score+=this.combo*(Game.W-2)*i*100,this.reloadCombo(),this.reloadScore(),Background.BLOCK_DESTROY.play()}reloadScore(){this.scoreElement.text(this.score)}reloadCombo(){this.comboElement.text(this.combo)}reloadTimer(){this.timerElement.text(this.timeLimit)}gameOver(){textSize(50),fill(this.variablesForGameOver.red,0,0),this.variablesForGameOver.red++,text("Game Over",this.x+26,this.y+350);for(let t=0;t<Game.H;t++)this.field[t][0].draw();for(let t=0;t<Game.H;t++)this.field[t][Game.W-1].draw();for(let t=1;t<Game.W-1;t++)this.field[Game.H-1][t].draw()}draw(){if(!this.variablesForGameOver.isGameOver){for(let t=0;t<Game.H;t++)for(let e=0;e<Game.W;e++)this.field[t][e].draw();return frameCount%60==0&&(this.reloadTimer(),this.timeLimit--),this.timeLimit<0?(this.variablesForGameOver.isGameOver=!0,Background.pause(),void Background.GAMEOVER.play()):this.activeMino.isActive||(this.activeMino=Mino.createMino(Game.START_X,Game.START_Y,!0,this),null!==this.activeMino)?void this.activeMino.draw(this):(this.variablesForGameOver.isGameOver=!0,Background.pause(),void Background.GAMEOVER.play())}this.gameOver()}showField(){for(let t=0;t<Game.H;t++){let e=this.field[t].map((t=>Number(t.getLit())));console.log(e.toString())}}}let player;function preload(){Background.loadBGMS(),Pattern.setDesign()}function setup(){let t=createCanvas(1280,800);Background.set(),t.parent("screen"),player=new Player(490,50)}function draw(){background(0),Background.loopBGM(),player.draw()}class Mino{static NUM=4;constructor(t,e,i,s){this.x=t,this.y=e,this.pattern=i,this.blocks=new Array(Mino.NUM);for(let s=0;s<Mino.NUM;s++)this.blocks[s]=[t+Pattern.SHAPES[i][s][0],e+Pattern.SHAPES[i][s][1]];this.isActive=s}static createMino(t,e,i,s){let o=Math.floor(Math.random()*Pattern.NUM),a=new Mino(t,e,o,i);return a.blocks.some((t=>s.getBlock(t[1],t[0]).getIsLocked()))&&(a=null),a}judgeLeft(t){return this.blocks.some((e=>t[e[1]][e[0]-1].getIsLocked()))}judgeRight(t){return this.blocks.some((e=>t[e[1]][e[0]+1].getIsLocked()))}judgeBottom(t){return this.blocks.some((e=>t[e[1]+1][e[0]].getIsLocked()))}moveLeft(t){if(!this.judgeLeft(t)){this.x-=1;for(let e=0;e<Mino.NUM;e++){let i=this.blocks[e];t[i[1]][i[0]].setLit(!1),i[0]-=1}}}moveRight(t){if(!this.judgeRight(t)){this.x+=1;for(let e=0;e<Mino.NUM;e++){let i=this.blocks[e];t[i[1]][i[0]].setLit(!1),i[0]+=1}}}moveDown(t){if(!this.judgeBottom(t)){this.y+=1;for(let e=0;e<Mino.NUM;e++){let i=this.blocks[e];t[i[1]][i[0]].setLit(!1),i[1]+=1}}}static myCopy(t){let e=new Array(Mino.NUM);for(let i=0;i<Mino.NUM;i++)e[i]=[t[i][0],t[i][1]];return e}rotateLeft(t){let e=Mino.myCopy(this.blocks);try{let e=0;for(let i=0;i<Mino.NUM;i++){let s=this.blocks[i];t[s[1]][s[0]].setLit(!1);let o=s[0]-this.x,a=s[1]-this.y;if([o,a]=[-a,o],[s[0],s[1]]=[this.x+o,this.y+a],s[1]>=Game.h||t[s[1]][s[0]]){let i=0,o=s[1];for(;o>=Game.h||t[o][s[0]].getIsLocked();)o--,i++;e=max(e,i)}}for(let t=0;t<Mino.NUM;t++)this.y-=e,this.blocks[t][1]-=e}catch(t){t instanceof TypeError?this.blocks=e:console.error(t)}}rotateRight(t){let e=Mino.myCopy(this.blocks);try{let e=0;for(let i=0;i<Mino.NUM;i++){let s=this.blocks[i];t[s[1]][s[0]].setLit(!1);let o=s[0]-this.x,a=s[1]-this.y;if([o,a]=[a,-o],[s[0],s[1]]=[this.x+o,this.y+a],s[1]>=Game.h||t[s[1]][s[0]]){let i=0,o=s[1];for(;o>=Game.h||t[o][s[0]].getIsLocked();)o--,i++;e=max(e,i)}}for(let t=0;t<Mino.NUM;t++)this.y-=e,this.blocks[t][1]-=e}catch(t){t instanceof TypeError?this.blocks=e:console.error(t)}}lock(t){let e=t.field,i=10**9;for(let t=0;t<Mino.NUM;t++){let s=this.blocks[t];e[s[1]][s[0]].setLit(!0),e[s[1]][s[0]].setIsLocked(!0),i=min(i,s[1])}this.isActive=!1,t.top=min(t.top,i)}draw(t){let e=t.field;if(this.isActive){if(this.judgeBottom(e)&&frameCount%30==0)return this.lock(t),void t.breakOut();if(keyIsPressed&&frameCount%6==0)switch(key){case"j":this.moveLeft(e);break;case"k":this.moveDown(e),this.moveDown(e),this.moveDown(e);break;case"l":this.moveRight(e);break;case"a":this.rotateLeft(e);break;case"d":this.rotateRight(e)}frameCount%t.fallSpeed==0&&this.moveDown(e);for(let t=0;t<Mino.NUM;t++){let i=this.blocks[t],s=e[i[1]][i[0]];s.setDesign(Pattern.DESINGS[this.pattern]),s.setLit(!0)}}}}class MyFunctions{static showMemory(t){if(frameCount%t!=0)return;let e=performance.memory;console.log(e);let i=e.usedJSHeapSize/e.jsHeapSizeLimit;console.log(`メモリ使用率: ${100*i} %`),console.log(`----稼働時間: ${frameCount/60}秒----`)}static shuffle(t){for(let e=t.length-1;e>=0;e--){let i=Math.floor(Math.random()*e);[t[e],t[i]]=[t[i],t[e]]}}}class Pattern{static NUM=7;static SHAPES=[[[-1,0],[0,-1],[0,0],[1,0]],[[0,0],[0,1],[1,1],[2,1]],[[0,0],[1,0],[2,0],[2,-1]],[[0,0],[1,0],[1,1],[0,1]],[[0,-1],[0,0],[0,1],[0,2]],[[-1,0],[0,0],[0,1],[1,1]],[[-1,0],[0,0],[0,-1],[1,-1]]];static DESINGS=new Array(Pattern.NUM+1);static setDesign(){for(let t=0;t<Pattern.NUM+1;t++)Pattern.DESINGS[t]=loadImage(`assets/img/pattern${t}.png`)}}class Player{constructor(t,e){this.game=new Game(t,e),Object.seal(this)}draw(){this.game.draw()}}