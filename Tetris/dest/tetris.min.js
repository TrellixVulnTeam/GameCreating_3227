class Background{static BGM_NUM=4;static INTERVAL_OF_BGM=11400;static loadBGMS(){Background.BGMS=new Array(Background.BGM_NUM);for(let t=0;t<Background.BGM_NUM;t++)Background.BGMS[t]=loadSound(`assets/sound/bgm${t}.mp3`);Background.BLOCK_DESTROY=loadSound("assets/sound/block_destroy.mp3"),Background.GAMEOVER=loadSound("assets/sound/game_over.mp3")}static set(){Background.indexOfBGM=3,Background.playingCount=1e9,MyFunctions.shuffle(Background.BGMS)}static pause(){Background.BGMS[Background.indexOfBGM].pause(),Background.playingCount=0}static loopBGM(){Background.playingCount>Background.INTERVAL_OF_BGM&&keyIsPressed?(Background.indexOfBGM=(Background.indexOfBGM+1)%Background.BGM_NUM,Background.playingCount=0,Background.BGMS[Background.indexOfBGM].play()):Background.playingCount++}}class Block{static L=20;constructor(t,e,i=0){console.log(Block.L),this.x=t,this.y=e,this.design=Pattern.DESINGS[i],this.lit=!1,this.isLocked=!1,Object.seal(this)}getLit(){return this.lit}setLit(t){this.lit=t}getIsLocked(){return this.isLocked}setIsLocked(t){this.isLocked=t}getDesign(){return this.design}setDesign(t){this.design=t}clone(t){this.design=t.design,this.lit=t.lit,this.isLocked=t.isLocked}draw(){this.lit&&image(this.design,this.x,this.y,Block.L,Block.L)}}class Game{static W=15;static H=32;static START_X=6;static START_Y=1;static DEFAULT_FALL_SPEED=30;constructor(t,e){this.x=t,this.y=e,this.field=new Array(Game.H),this.fallSpeed=Game.DEFAULT_FALL_SPEED,this.top=Game.H-1,this.score=0,this.combo=0,this.scoreElement=$("#score"),this.comboElement=$("#combo"),this.timerElement=$("#timer"),this.timeLimit=180,this.variablesForGameOver={isGameOver:!1,red:0};for(let i=0;i<Game.H;i++){this.field[i]=new Array;for(let e=0;e<Game.W;e++){let t=new Block(this.x+e*Block.L+2*e,this.y+i*Block.L+2*i,Pattern.NUM);i!=Game.H-1&&0!=e&&e!=Game.W-1||(t.setLit(!0),t.setIsLocked(!0)),this.field[i].push(t)}}this.activeMino=Mino.createMino(Game.START_X,Game.START_Y,!0,this),Object.seal(this)}getBlock(t,e){return this.field[t][e]}shift(t,i){if(0<t-i){var s=this.field[t-i];let e=this.field[t];for(let t=1;t<Game.W-1;t++)e[t].clone(s[t])}else{console.log("i - d <= 0",t,i);let e=this.field[t];for(let t=1;t<Game.W-1;t++)e[t].setLit(!1),e[t].setIsLocked(!1)}}breakOut(){let t;for(t=Game.H-2;t>=this.top;t--)if(this.field[t].every(t=>t.getLit())){t;break}var e=t;for(t=e;t>=this.top&&!this.field[t].some(t=>!t.getLit());t--);var i=e-t;if(0==i)return this.combo=0,void this.reloadCombo();for(let t=e;t>=this.top;t--)this.shift(t,i);this.top+=i,this.combo++,this.score+=this.combo*(Game.W-2)*i*100,this.reloadCombo(),this.reloadScore(),Background.BLOCK_DESTROY.play()}reloadScore(){this.scoreElement.text(this.score)}reloadCombo(){this.comboElement.text(this.combo)}reloadTimer(){this.timerElement.text(this.timeLimit)}gameOver(){textSize(50),fill(this.variablesForGameOver.red,0,0),this.variablesForGameOver.red++,text("Game Over",this.x+26,this.y+350);for(let t=0;t<Game.H;t++)this.field[t][0].draw();for(let t=0;t<Game.H;t++)this.field[t][Game.W-1].draw();for(let t=1;t<Game.W-1;t++)this.field[Game.H-1][t].draw()}draw(){if(!this.variablesForGameOver.isGameOver){for(let e=0;e<Game.H;e++)for(let t=0;t<Game.W;t++)this.field[e][t].draw();return frameCount%60==0&&(this.reloadTimer(),this.timeLimit--),!(this.timeLimit<0)&&(this.activeMino.isActive||(this.activeMino=Mino.createMino(Game.START_X,Game.START_Y,!0,this),null!==this.activeMino))?void this.activeMino.draw(this):(this.variablesForGameOver.isGameOver=!0,Background.pause(),void Background.GAMEOVER.play())}this.gameOver()}showField(){for(let e=0;e<Game.H;e++){let t=this.field[e].map(t=>Number(t.getLit()));console.log(t.toString())}}}let player;function preload(){Pattern.setDesign()}function setup(){let t=createCanvas(1280,800);t.parent("screen"),player=new Player(490,50)}function draw(){background(0),player.draw()}window.addEventListener("click",()=>{console.log(document.cookie)});class Mino{static NUM=4;constructor(e,i,s,t){this.x=e,this.y=i,this.pattern=s,this.blocks=new Array(Mino.NUM);for(let t=0;t<Mino.NUM;t++)this.blocks[t]=[e+Pattern.SHAPES[s][t][0],i+Pattern.SHAPES[s][t][1]];this.isActive=t}static createMino(t,e,i,s){var o=Math.floor(Math.random()*Pattern.NUM);let a=new Mino(t,e,o,i);return a.blocks.some(t=>s.getBlock(t[1],t[0]).getIsLocked())&&(a=null),a}judgeLeft(e){return this.blocks.some(t=>e[t[1]][t[0]-1].getIsLocked())}judgeRight(e){return this.blocks.some(t=>e[t[1]][t[0]+1].getIsLocked())}judgeBottom(e){return this.blocks.some(t=>e[t[1]+1][t[0]].getIsLocked())}moveLeft(i){if(!this.judgeLeft(i)){--this.x;for(let e=0;e<Mino.NUM;e++){let t=this.blocks[e];i[t[1]][t[0]].setLit(!1),--t[0]}}}moveRight(i){if(!this.judgeRight(i)){this.x+=1;for(let e=0;e<Mino.NUM;e++){let t=this.blocks[e];i[t[1]][t[0]].setLit(!1),t[0]+=1}}}moveDown(i){if(!this.judgeBottom(i)){this.y+=1;for(let e=0;e<Mino.NUM;e++){let t=this.blocks[e];i[t[1]][t[0]].setLit(!1),t[1]+=1}}}static myCopy(e){let i=new Array(Mino.NUM);for(let t=0;t<Mino.NUM;t++)i[t]=[e[t][0],e[t][1]];return i}rotateLeft(o){var e=Mino.myCopy(this.blocks);try{let s=0;for(let t=0;t<Mino.NUM;t++){let i=this.blocks[t];o[i[1]][i[0]].setLit(!1);var a=i[0]-this.x,r=i[1]-this.y;if([a,r]=[-r,a],[i[0],i[1]]=[this.x+a,this.y+r],i[1]>=Game.h||o[i[1]][i[0]]){let t=0,e=i[1];for(;e>=Game.h||o[e][i[0]].getIsLocked();)e--,t++;s=max(s,t)}}for(let t=0;t<Mino.NUM;t++)this.y-=s,this.blocks[t][1]-=s}catch(t){t instanceof TypeError?this.blocks=e:console.error(t)}}rotateRight(o){var e=Mino.myCopy(this.blocks);try{let s=0;for(let t=0;t<Mino.NUM;t++){let i=this.blocks[t];o[i[1]][i[0]].setLit(!1);var a=i[0]-this.x,r=i[1]-this.y;if([a,r]=[r,-a],[i[0],i[1]]=[this.x+a,this.y+r],i[1]>=Game.h||o[i[1]][i[0]]){let t=0,e=i[1];for(;e>=Game.h||o[e][i[0]].getIsLocked();)e--,t++;s=max(s,t)}}for(let t=0;t<Mino.NUM;t++)this.y-=s,this.blocks[t][1]-=s}catch(t){t instanceof TypeError?this.blocks=e:console.error(t)}}lock(t){let e=t.field,i=1e9;for(let t=0;t<Mino.NUM;t++){var s=this.blocks[t];e[s[1]][s[0]].setLit(!0),e[s[1]][s[0]].setIsLocked(!0),i=min(i,s[1])}this.isActive=!1,t.top=min(t.top,i)}draw(t){var i=t.field;if(this.isActive){if(this.judgeBottom(i)&&frameCount%30==0)return this.lock(t),void t.breakOut();if(keyIsPressed&&frameCount%6==0)switch(key){case"j":this.moveLeft(i);break;case"k":this.moveDown(i),this.moveDown(i),this.moveDown(i);break;case"l":this.moveRight(i);break;case"a":this.rotateLeft(i);break;case"d":this.rotateRight(i)}frameCount%t.fallSpeed==0&&this.moveDown(i);for(let e=0;e<Mino.NUM;e++){var s=this.blocks[e];let t=i[s[1]][s[0]];t.setDesign(Pattern.DESINGS[this.pattern]),t.setLit(!0)}}}}class MyFunctions{static showMemory(t){frameCount%t==0&&(t=performance.memory,console.log(t),t=t.usedJSHeapSize/t.jsHeapSizeLimit,console.log(`メモリ使用率: ${100*t} %`),console.log(`----稼働時間: ${frameCount/60}秒----`))}static shuffle(e){for(let t=e.length-1;0<=t;t--){var i=Math.floor(Math.random()*t);[e[t],e[i]]=[e[i],e[t]]}}}class Pattern{static NUM=7;static SHAPES=[[[-1,0],[0,-1],[0,0],[1,0]],[[0,0],[0,1],[1,1],[2,1]],[[0,0],[1,0],[2,0],[2,-1]],[[0,0],[1,0],[1,1],[0,1]],[[0,-1],[0,0],[0,1],[0,2]],[[-1,0],[0,0],[0,1],[1,1]],[[-1,0],[0,0],[0,-1],[1,-1]]];static DESINGS=new Array(Pattern.NUM+1);static setDesign(){for(let t=0;t<Pattern.NUM+1;t++)Pattern.DESINGS[t]=loadImage(`assets/img/tetris/pattern${t}.png`)}}class Player{constructor(t,e){this.game=new Game(t,e),Object.seal(this)}draw(){this.game.draw()}}