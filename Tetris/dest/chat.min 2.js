"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}var _react=_interopRequireDefault(require("react")),_reactDom=_interopRequireDefault(require("react-dom")),_socket=_interopRequireDefault(require("socket.io-client"));function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function _createClass(t,e,n){return e&&_defineProperties(t.prototype,e),n&&_defineProperties(t,n),t}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&_setPrototypeOf(t,e)}function _setPrototypeOf(t,e){return(_setPrototypeOf=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function _createSuper(n){var r=_isNativeReflectConstruct();return function(){var t,e=_getPrototypeOf(n);return _possibleConstructorReturn(this,r?(t=_getPrototypeOf(this).constructor,Reflect.construct(e,arguments,t)):e.apply(this,arguments))}}function _possibleConstructorReturn(t,e){if(e&&("object"===_typeof(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(t)}function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(t){return!1}}function _getPrototypeOf(t){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}var Chat=function(){_inherits(n,_react["default"].Component);var e=_createSuper(n);function n(){var t;return _classCallCheck(this,n),(t=e.call(this)).state={comments:[],input:{value:[""],row:1},isActive:!1},t.usedID={},t.updateInput=t.updateInput.bind(_assertThisInitialized(t)),t.addComment=t.addComment.bind(_assertThisInitialized(t)),t.enterPost=t.enterPost.bind(_assertThisInitialized(t)),t.textarea=_react.default.createRef(),t.commentsBottom=_react.default.createRef(),t.socket=(0,_socket.default)("localhost:5000"),t}return _createClass(n,[{key:"generateID",value:function(){for(var t=Math.floor(Math.random()*Number.MAX_SAFE_INTEGER);this.usedID[t];);return this.usedID[t]=!0,t}},{key:"enterPost",value:function(t){"Enter"===t.key&&(t.crtlKey||t.metaKey)&&this.addComment(t)}},{key:"sendData",value:function(e){var n=this;this.socket.emit("addCommentRequest",{comments:e}),this.socket.on("addCommentResponse",function(t){console.log(e),console.log(t.comments),n.setState({comments:t.comments})})}},{key:"addComment",value:function(t){t.preventDefault();var e=this.state.input.value,t=this.generateID();n.validation(e)&&(e=n.generateComment(e,t),(t=this.state.comments).push(e),this.setState({input:{value:[""],row:1}}),this.commentsBottom.current.scrollIntoView(),this.sendData(t))}},{key:"updateInput",value:function(t){var e=this.state.input.row,n=Mylib.split(t.target.value,"\n");n[a=e-1]||(n[a]="");var r=n[e-1].length>this.state.input.value[e-1].length;if(r&&"\n"===t.target.value.slice(-1)){if(3===e)return;n.push(""),e++}else if(30<Mylib.charCount(n[e-1])){if(3===e)return;var a=n[e-1].split(""),t=a.slice(-1);a[a.length-1]="\n",n[e-1]=a.join(""),n.push(t),e++}else 1<e&&!r&&!n[e-1]&&"\n"!==n[e-2].slice(-1)&&(n.pop(),e--);this.setState({input:{value:n,row:e}})}},{key:"activateInput",value:function(){this.setState({isActive:!(0<arguments.length&&void 0!==arguments[0])||arguments[0]})}},{key:"render",value:function(){var e=this;return _react.default.createElement("div",{id:"chat",onClick:function(t){t=t.target;"input-container"===t.id||"input"===t.parentNode.id?(e.activateInput(),e.textarea.current.focus()):e.activateInput(!1)}},_react.default.createElement("div",{id:"chat-space"},_react.default.createElement("div",{id:"comments-container"},_react.default.createElement("ul",null,this.state.comments),_react.default.createElement("div",{ref:this.commentsBottom,id:"comments-bottom"})),_react.default.createElement(Input,{textarea:this.textarea,params:this.state.input,isActive:this.state.isActive,update:this.updateInput,addComment:this.addComment,enterPost:this.enterPost})))}}],[{key:"validation",value:function(t){t=t.join("");return 0<t.length&&t.match(/[^ 　\n\t]/)}},{key:"generateComment",value:function(t,e){var n="url(../assets/img/chat/cloud".concat(Mylib.rand(0,5),".png)"),r=0;t.forEach(function(t){r=Math.max(r,Mylib.charCount(t))}),r*=20,r=Math.max(r,100),a=(r=Math.min(r,380))*(100/280)*(t.length/3)*1.5;var a=Math.max(a,70),o="".concat(Mylib.rand(-60,200),"px"),n={width:"".concat(r,"px"),height:"".concat(a,"px"),marginLeft:o,backgroundSize:"".concat(r,"px ").concat(a,"px"),backgroundImage:n};return _react.default.createElement(Comment,{key:e,value:t,style:n})}}]),n}();function Comment(t){return _react.default.createElement("div",{className:"comment",style:t.style},_react.default.createElement("li",null,t.value.map(function(t,e){return _react.default.createElement("p",{key:e},t)})))}function Input(t){return _react.default.createElement("div",{id:"input-container",className:t.isActive?"active":""},_react.default.createElement("form",{id:"input",autoFocus:!0,onKeyDown:t.enterPost},_react.default.createElement("textarea",{value:t.params.value.join(""),ref:t.textarea,rows:t.params.row,wrap:"hard",onChange:t.update}),_react.default.createElement("input",{type:"submit",value:"送信",title:"ctrl+Enter",onClick:t.addComment})))}_reactDom.default.render(_react.default.createElement(_react.default.StrictMode,null,_react.default.createElement(Chat,null)),document.getElementById("root"));var Mylib=function(){function t(){_classCallCheck(this,t)}return _createClass(t,null,[{key:"charCount",value:function(t){for(var e=0,n=0;n<t.length;n++)t.match(/^[\u30a0-\u30ff\u3040-\u309f\u3005-\u3006\u30e0-\u9fcf]+$/)?e+=2:e+=1;return e}},{key:"split",value:function(t,e){for(var n=[],r="",a=0;a<t.length;a++)r+=t[a],t[a]===e&&(n.push(r),r="");return r&&n.push(r),n}},{key:"rand",value:function(t,e){return t+Math.floor(Math.random()*e)}}]),t}();